{% extends "tasks/base.html" %}

{% block content %}

{% block javascript %}
  <script>
  	$(function() {
        $("#task_list").sortable();
    });

	$(document).on('change', '.tasks', function() {
		var task_id = $(this).val();

		$.ajax({
			url: "{% url 'tasks:complete' %}",
			type: 'POST',
			data: {
				'task_id': task_id,
				'csrfmiddlewaretoken': '{{ csrf_token }}',
			},
			success: function (data) { },
			failure: function(data) { }
		});
	});

	$(document).on('click', '#add_task', function() {
		$('#add_task').remove();
		$('#task_list').append("<li id='new_task'><form action=\'{% url 'tasks:addTask' %}\' method='POST'>{% csrf_token %}<input type='hidden' name='task_type' value='{{ page_type }}'/><input type='checkbox' name='new_task_completion'/><input type='text' name='new_task_text' size='15'/><button type='submit'>Add</button><button type='button' id='cancel_add'>X</button></form></li>"); 
	});


	$(document).on('click', '#cancel_add', function() {
		$('#new_task').remove();
		$('#add_button_div').append("<button type='button' class='btn btn-primary pull-left' id='add_task'><i class='fa fa-plus'></i> Add Task</button>"); 
	});

	$(document).on('click', '#delete', function() {
		$(this).closest('form').submit();
	});

	$(document).on('click', '#confirm_edit', function() {
		$(this).closest('form').submit();
	});


	$(document).on('click', '#edit', function() {
		var parent_li = $(this).closest('li');
		var old_task_text = parent_li.find('span#task_text').text().trim();
		parent_li.find('span#task_text').hide();
		parent_li.find('div.tools').empty();

		parent_li.append("<form id='edit_task_form' method='POST' action=\'{% url 'tasks:editTask' %}\'>{% csrf_token %}<input type='hidden' name='task_id' value="+parent_li.find('input.tasks').val()+"><input type='text' id='edit_task_text' name='task_text' value='"+old_task_text+"'><div class='edit_tools'><i class='fa fa-check' id='confirm_edit'></i><i class='fa fa-times' id='cancel_edit'></i></div></form>")
		
	});

	$(document).on('click', '#cancel_edit', function() {
		var parent_li = $(this).closest('li');
		parent_li.find('span#task_text').show();
		$('#edit_task_text').remove();
		$('.edit_tools').empty();
		
		parent_li.append("<div class='tools'><i class='fa fa-edit' id='edit'></i><form id='delete_task_form' method='POST' action=\'{% url 'tasks:deleteTask' %}\'>{% csrf_token %}<input type='hidden' name='task_id' value='"+parent_li.find('input.tasks').val()+"'><i class='fa fa-trash-o' id='delete' type='submit'></i></form></div>")

	});

  </script>
{% endblock %}


<div class="row">
  	<div class="col-md-6">

  		<!-- Paging -->
      	<div class="box-header ui-sortable-handle">
        	<h3 class="box-title">{{ page_type }}</h3>
        	<div class="box-tools pull-right">
	          	<nav aria-label="...">
				  <ul class="pagination">
			
				    <li class="page-item {% if page_type == 'Once' %}active{% endif %}"><a class="page-link" href="/tasks/once">O</a></li>
				    <li class="page-item {% if page_type == 'Daily' %}active{% endif %}"><a class="page-link" href="/tasks/day">D</a></li>
				    <li class="page-item {% if page_type == 'Monthly' %}active{% endif %}"><a class="page-link" href="/tasks/month">M</a></li>
				    <li class="page-item {% if page_type == 'Yearly' %}active{% endif %}"><a class="page-link" href="/tasks/year">Y</a></li>
				  </ul>
				</nav>
        	</div>
      	</div>
 		
 		<!-- To do list body -->
      	<div class="box-body">
	        <ul class="todo-list ui-sortable" id="task_list">
	        	{% if task_list %}
	        	{% for task in task_list %}
	          	<li>
		            <input type="checkbox" class="tasks" name="tasks[]" value="{{ task.id }}" {% if task.completed %} checked=checked {% endif %}/>
		            <span id="task_text">
		            	<!-- <a href="{% url 'tasks:detail' task.id %}"> -->
		            	{{ task.task_text }}
		            	<!-- </a> -->
		            </span>
		            <div class="tools">
		              	<i class="fa fa-edit" id="edit"></i>
		              	<form id="delete_task_form" method="POST" action="{% url 'tasks:deleteTask' %}">{% csrf_token %}<input type="hidden" name="task_id" value="{{ task.id }}"><i class="fa fa-trash-o" id='delete' type='submit'></i></form>
		            </div>
	          	</li>
	         	{% endfor %}
	         	{% endif %}
	        </ul>
      	</div>
    	
    	<!-- Add new task button -->
    	<div class="box-body" id="add_button_div">
      		<button class="btn btn-primary pull-left" id="add_task" href="#" ><i class="fa fa-plus"></i> Add Task</button>
      	</div>
  	
  	</div> 
    
</div>

{% endblock %}